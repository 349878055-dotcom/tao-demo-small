<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é‡å¿ƒé”šå®šç³»ç»Ÿ | åŒè·¯å¯¹ç„¦</title>
    <style>
        body { background: #0a0a0a; color: #e0e0e0; font-family: sans-serif; margin: 0; display: flex; justify-content: center; padding: 15px; }
        .container { width: 100%; max-width: 850px; background: #141414; border-radius: 12px; display: flex; flex-direction: column; height: 95vh; border: 1px solid #222; overflow: hidden; }
        #status-bar { padding: 15px 20px; background: #111; border-bottom: 1px solid #222; }
        .status-line { display: flex; justify-content: space-between; align-items: center; height: 35px; }
        .label { color: #444; font-weight: bold; font-size: 11px; width: 110px; }
        #suggest-box { color: #aaa; font-size: 13px; flex: 1; font-style: italic; }
        #locked-box { color: #333; font-weight: bold; font-size: 14px; flex: 1; }
        .active-lock { color: #27ae60 !important; }
        .btn-group { display: flex; gap: 8px; }
        .btn { font-size: 10px; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-ok { background: #1a1a1a; color: #27ae60; border: 1px solid #27ae60; }
        .btn-edit { background: #222; color: #666; }
        #display { flex: 1; overflow-y: auto; padding: 25px; }
        .row { margin-bottom: 25px; }
        .tag { font-size: 10px; color: #333; margin-bottom: 6px; font-weight: bold; }
        .content { line-height: 1.8; border-left: 2px solid #222; padding-left: 18px; color: #bbb; }
        .locked-line { border-left-color: #27ae60 !important; color: #fff; }
        .input-area { display: flex; padding: 20px; background: #0d0d0d; border-top: 1px solid #222; gap: 15px; }
        input { flex: 1; background: #181818; border: 1px solid #333; color: white; padding: 12px; border-radius: 6px; outline: none; }
        button#send-btn { background: #222; color: white; border: 1px solid #444; padding: 0 30px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div id="status-bar">
            <div class="status-line">
                <span class="label">ğŸ“¡ é›·è¾¾æ¨æµ‹:</span>
                <span id="suggest-box">å‡†å¤‡å°±ç»ª...</span>
                <button class="btn btn-ok" onclick="confirmIntent()">ç¡®è®¤/åŒæ­¥</button>
            </div>
            <div class="status-line" style="border-top: 1px solid #222; margin-top: 8px; padding-top: 8px;">
                <span class="label">ğŸ¯ é”å®šé‡å¿ƒ:</span>
                <span id="locked-box">å°šæœªé”å®š</span>
                <button class="btn btn-edit" onclick="editIntent()">æ‰‹åŠ¨ä¿®æ”¹</button>
            </div>
        </div>
        <div id="display"></div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="åœ¨æ­¤è¾“å…¥...">
            <button id="send-btn" onclick="send()">å‘é€</button>
        </div>
    </div>
    <script>
        const display = document.getElementById('display'), suggestBox = document.getElementById('suggest-box'), 
              lockedBox = document.getElementById('locked-box'), input = document.getElementById('userInput');
        let hasLocked = false, currentLocked = "";

        async function confirmIntent() {
            const res = await fetch(`/chat?q=é”å®š`);
            const data = await res.json();
            updateUI(data.reply);
        }

        async function editIntent() {
            const n = prompt("è¯·è¾“å…¥æ ¸å¿ƒé‡å¿ƒ:");
            if(n) {
                const res = await fetch(`/chat?force=${encodeURIComponent(n)}`);
                const data = await res.json();
                currentLocked = n;
                updateUI(data.reply, true);
            }
        }

        function updateUI(reply, f = false) {
            let isL = f, cR = reply;
            if(reply.startsWith("CONFIRMED_SIGNAL|")) {
                cR = reply.split("|")[1]; isL = true; currentLocked = suggestBox.innerText;
            } else if(reply.startsWith("SYSTEM_UPDATE|")) {
                cR = reply.split("|")[1]; isL = true; currentLocked = cR.split("ï¼š")[1];
            } else if(reply.includes("|SUGGEST|")) {
                const p = reply.split("|SUGGEST|"); cR = p[0]; suggestBox.innerText = p[1].trim();
            }
            if(isL || hasLocked) {
                hasLocked = true; lockedBox.innerText = currentLocked;
                lockedBox.classList.add('active-lock');
            }
            display.innerHTML += `<div class="row"><div class="tag">AI COUNSELOR</div><div class="content ${hasLocked?'locked-line':''}">${cR.replace(/\\n/g,'<br>')}</div></div>`;
            display.scrollTop = display.scrollHeight;
        }

        async function send() {
            const v = input.value.trim(); if(!v) return;
            display.innerHTML += `<div class="row"><div class="tag">USER</div><div class="content">${v}</div></div>`;
            input.value = '';
            const res = await fetch(`/chat?q=${encodeURIComponent(v)}`);
            const data = await res.json();
            updateUI(data.reply);
        }
        input.onkeypress = (e) => e.key === 'Enter' && send();
    </script>
</body>
</html>