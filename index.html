<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>战略幕僚决策系统 | Stanford Research Style</title>
    <style>
        :root {
            --stanford-red: #8C1515;
            --bg-gray: #F9F9F9;
            --text-dark: #2E2D29;
            --border-light: #D5D5D5;
            --accent-gold: #B26F16;
        }

        body { 
            background: var(--bg-gray); 
            color: var(--text-dark); 
            font-family: "Source Sans Pro", "PingFang SC", "Helvetica Neue", sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding-top: 180px; 
            margin: 0; 
        }

        /* 优化后的顶部导航栏：采用 Flex 布局确保元素互不重叠 */
        #top-monitor { 
            display: flex; 
            gap: 24px; 
            padding: 15px 40px; 
            background: rgba(255, 255, 255, 0.98); 
            backdrop-filter: blur(12px); 
            position: fixed; 
            top: 0; 
            width: 100%; 
            box-sizing: border-box;
            justify-content: center; 
            align-items: center;
            z-index: 1000; 
            border-bottom: 2px solid var(--stanford-red);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* 将工具栏嵌入导航条最右侧 */
        #top-utilities {
            position: absolute;
            right: 40px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .lang-group { display: flex; gap: 12px; align-items: center; }

        .util-btn { cursor: pointer; color: #888; transition: 0.2s; border-bottom: 1px solid transparent; }
        .util-btn:hover { color: var(--stanford-red); }
        .util-btn.active { color: var(--stanford-red); border-bottom: 1px solid var(--stanford-red); }

        .reset-trigger { 
            color: #8C1515; 
            border: 1px solid var(--stanford-red); 
            padding: 2px 10px; 
            border-radius: 0px; 
            background: transparent; 
            font-size: 10px;
            transition: 0.2s;
        }
        .reset-trigger:hover { background: var(--stanford-red); color: #fff; }

        .node { 
            width: 320px; padding: 12px 20px; 
            border: 1px solid var(--border-light); 
            border-radius: 0; 
            text-align: left; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            background: #FFFFFF; 
        }
        .node:hover { border-color: var(--stanford-red); background: #FFF9F9; }
        .node.active { 
            border: 2px solid var(--stanford-red); 
            box-shadow: 0 4px 12px rgba(140, 21, 21, 0.1);
        }

        .label { 
            font-size: 9px; font-weight: 700; color: var(--stanford-red); 
            margin-bottom: 4px; letter-spacing: 1.2px; text-transform: uppercase;
        }
        .val { font-size: 14px; font-weight: 600; color: #444; min-height: 1.2em; line-height: 1.3; }

        #analysis-stage { width: 850px; margin-bottom: 80px; }
        .history-entry { margin-bottom: 50px; border-top: 1px solid var(--border-light); padding-top: 30px; scroll-margin-top: 220px; }
        
        .basic-card { 
            padding: 30px; background: #FFFFFF; border: 1px solid var(--border-light); 
            margin-bottom: 25px; color: #444; line-height: 1.8; font-size: 16px;
        }
        
        .content-card { 
            background: #FFFFFF; border: 1px solid var(--border-light); 
            padding: 40px; margin-bottom: 25px; line-height: 1.8; 
            border-left: 8px solid var(--stanford-red);
            box-shadow: 4px 4px 0px rgba(0,0,0,0.02);
        }

        .section-header { 
            color: var(--stanford-red); font-family: "Georgia", serif; 
            font-size: 24px; font-weight: 800; margin-bottom: 20px; 
            display: block; border-bottom: 1px solid var(--stanford-red); padding-bottom: 10px; 
        }

        .sub-title { color: var(--text-dark); font-weight: 700; display: block; margin-top: 25px; font-size: 18px; }
        .list-item { margin: 14px 0; display: flex; align-items: flex-start; color: #555; font-size: 16px; }
        .list-item::before { content: "•"; color: var(--stanford-red); margin-right: 15px; font-size: 20px; line-height: 1; }
        .highlight { color: var(--stanford-red); font-weight: 700; }

        .input-box { margin-top: 40px; display: flex; width: 850px; margin-bottom: 100px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        input { flex: 1; background: #FFFFFF; border: 1px solid var(--border-light); color: var(--text-dark); padding: 20px; outline: none; font-size: 16px; }
        button { background: var(--stanford-red); border: none; color: #FFFFFF; padding: 0 45px; cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; }
        button:hover { background: #6b0f0f; }

        /* 适配小屏幕，防止挤压 */
        @media (max-width: 1100px) {
            #top-utilities { position: relative; right: auto; flex-direction: row; margin-left: 20px; }
            #top-monitor { padding: 15px 10px; }
        }
    </style>
</head>
<body>

    <div id="top-monitor">
        <div class="node" id="main-node" onclick="confirmIntent('main')">
            <div class="label" id="lbl-main">Primary Strategic Conflict</div>
            <div id="main-val" class="val"></div>
        </div>
        <div class="node" id="hidden-node" onclick="confirmIntent('hidden')">
            <div class="label" id="lbl-hidden">Underlying Strategic Intent</div>
            <div id="hidden-val" class="val"></div>
        </div>

        <div id="top-utilities">
            <div class="lang-group">
                <span class="util-btn active" id="btn-zh" onclick="switchLang('zh')">ZH</span>
                <span style="color:#D5D5D5">|</span>
                <span class="util-btn" id="btn-en" onclick="switchLang('en')">EN</span>
            </div>
            <div class="util-btn reset-trigger" onclick="resetSystem()">RESET</div>
        </div>
    </div>

    <div id="analysis-stage"></div>

    <div class="input-box">
        <input type="text" id="userInput" placeholder="请输入您的研究课题或战略决策议题...">
        <button id="btn-submit" onclick="detect()">启动分析</button>
    </div>

    <script>
        let store = { main: "", hidden: "" };
        let currentLang = 'zh';

        const i18n = {
            zh: {
                mainLbl: "探测主要矛盾",
                hiddenLbl: "探测潜在意图",
                placeholder: "请输入您的研究课题或战略决策议题...",
                btnSubmit: "启动分析",
                analyzing: "正在分析...",
                probing: "正在探测...",
                subject: "研究议题",
                executing: "正在执行深度战略分析...",
                pivot: "确认战略重心",
                terminated: "分析终止。",
                resetMsg: "系统已重置。您可以开启新的议题或进行普通查询。"
            },
            en: {
                mainLbl: "Primary Strategic Conflict",
                hiddenLbl: "Underlying Strategic Intent",
                placeholder: "Enter your research subject or strategic issue...",
                btnSubmit: "Execute Analysis",
                analyzing: "Analyzing...",
                probing: "Probing...",
                subject: "Research Subject",
                executing: "Executing In-depth Strategic Analysis...",
                pivot: "Confirmed Strategic Pivot",
                terminated: "Analysis Terminated.",
                resetMsg: "System reset. You can start a new topic or general inquiry."
            }
        };

        function switchLang(lang) {
            currentLang = lang;
            document.querySelectorAll('.util-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + lang).classList.add('active');
            document.getElementById('lbl-main').innerText = i18n[lang].mainLbl;
            document.getElementById('lbl-hidden').innerText = i18n[lang].hiddenLbl;
            document.getElementById('userInput').placeholder = i18n[lang].placeholder;
            document.getElementById('btn-submit').innerText = i18n[lang].btnSubmit;
        }

        function resetSystem() {
            store = { main: "", hidden: "" };
            document.getElementById('main-val').innerText = "";
            document.getElementById('hidden-val').innerText = "";
            document.querySelectorAll('.node').forEach(n => n.classList.remove('active'));
            const stage = document.getElementById('analysis-stage');
            stage.innerHTML += `<div style="text-align:center; color:#8C1515; font-size:11px; margin: 30px 0; border-top:1px solid #D5D5D5; padding-top:10px; letter-spacing:1px; text-transform:uppercase;">${i18n[currentLang].resetMsg}</div>`;
            document.getElementById('userInput').value = '';
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function robustParse(raw) {
            let clean = raw.replace(/\\n/g, '\n').replace(/\\"/g, '"');
            const sections = clean.split(/(?=\d\.\s*【|###\s*)/g);
            let htmlOutput = "";
            sections.forEach(sec => {
                if (sec.trim().length < 5) return;
                let formatted = sec.replace(/(\d\.\s*【|###\s*)(.*?)(】|\n|$)/, '<span class="section-header">$2</span>');
                formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<span class="highlight">$1</span>');
                formatted = formatted.replace(/^- (.*?):/gm, '<span class="sub-title">$1</span>');
                formatted = formatted.replace(/^- (.*)/gm, '<div class="list-item">$1</div>');
                htmlOutput += `<div class="content-card">${formatted}</div>`;
            });
            return htmlOutput || `<div class="content-card">${raw}</div>`;
        }

        async function detect() {
            const inputField = document.getElementById('userInput');
            const q = inputField.value;
            if(!q) return;
            const t = i18n[currentLang];
            document.getElementById('main-val').innerText = t.analyzing;
            document.getElementById('hidden-val').innerText = t.probing;
            try {
                const res = await fetch(`/infer?q=${encodeURIComponent(q)}`);
                const data = await res.json();
                store = data;
                document.getElementById('main-val').innerText = data.main || "";
                document.getElementById('hidden-val').innerText = data.hidden || "";
                const stage = document.getElementById('analysis-stage');
                const newEntryId = 'chat-' + Date.now();
                stage.innerHTML += `
                    <div class="history-entry" id="${newEntryId}">
                        <div style="color: var(--stanford-red); font-weight:800; font-size:12px; margin-bottom:15px; text-transform:uppercase;">${t.subject}: ${q}</div>
                        <div class="basic-card">${data.chat_reply.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
                inputField.value = '';
                document.getElementById(newEntryId).scrollIntoView({ behavior: 'smooth' });
            } catch(e) {
                document.getElementById('main-val').innerText = "Connection Failed";
            }
        }

        async function confirmIntent(type) {
            const target = store[type];
            if(!target || target.includes("...")) return;
            const t = i18n[currentLang];
            document.querySelectorAll('.node').forEach(n => n.classList.remove('active'));
            document.getElementById(type + '-node').classList.add('active');
            const stage = document.getElementById('analysis-stage');
            const entryId = 'entry-' + Date.now();
            stage.innerHTML += `<div class="history-entry" id="${entryId}"><div style="text-align:center; color:var(--stanford-red); font-weight:bold; padding:40px;">${t.executing}</div></div>`;
            document.getElementById(entryId).scrollIntoView({ behavior: 'smooth' });
            try {
                const res = await fetch(`/analyze?target=${encodeURIComponent(target)}`);
                const content = await res.text();
                const container = document.getElementById(entryId);
                container.innerHTML = `
                    <div style="color: var(--stanford-red); margin-bottom: 25px; font-weight: bold; font-size: 14px; text-transform: uppercase;">${t.pivot}: ${target}</div>
                    ${robustParse(content)}
                `;
                container.scrollIntoView({ behavior: 'smooth' });
            } catch(e) {
                document.getElementById(entryId).innerHTML = t.terminated;
            }
        }
        switchLang('zh');
    </script>
</body>
</html>