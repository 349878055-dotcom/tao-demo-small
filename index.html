<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊàòÁï•ÂπïÂÉöÂÜ≥Á≠ñÁ≥ªÁªü | Stanford Research Style</title>
    <style>
        /* --- 1. Ê†∏ÂøÉÂèòÈáè‰∏éÂü∫Á°ÄÊ†∑Âºè --- */
        :root {
            --stanford-red: #8C1515;
            --bg-gray: #F9F9F9;
            --text-dark: #2E2D29;
            --border-light: #D5D5D5;
            --accent-gold: #B26F16;
        }

        body { 
            background: var(--bg-gray); 
            color: var(--text-dark); 
            font-family: "Source Sans Pro", "PingFang SC", "Helvetica Neue", sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding-top: 180px; 
            margin: 0; 
            transition: all 0.3s ease;
        }

        /* --- 2. Â∑¶‰æß‰∫∫Ê†ºÁõëÊéßÈù¢Êùø (Êó†ÊçüÊñ∞Â¢û) --- */
        #side-persona-monitor {
            position: fixed;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            width: 180px;
            background: #FFFFFF;
            border-left: 3px solid var(--stanford-red);
            padding: 20px;
            box-shadow: 2px 2px 15px rgba(0,0,0,0.05);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .scanner-title { 
            font-weight: 900; 
            font-size: 11px; 
            color: var(--stanford-red); 
            letter-spacing: 1.5px; 
            margin-bottom: 5px; 
        }

        .weight-box { display: flex; flex-direction: column; gap: 5px; }

        .weight-info { 
            font-size: 9px; 
            color: #666; 
            text-transform: uppercase; 
            display: flex; 
            justify-content: space-between; 
        }

        .progress-bg { height: 4px; background: #EEE; border-radius: 2px; overflow: hidden; }

        .progress-fill { 
            height: 100%; 
            background: var(--stanford-red); 
            width: 0%; 
            transition: width 1.5s cubic-bezier(0.1, 0, 0.3, 1); 
        }

        /* --- 3. È°∂ÈÉ®ÁõëÊéßÂØºËà™Ê†è --- */
        #top-monitor { 
            display: flex; 
            gap: 24px; 
            padding: 15px 40px; 
            background: rgba(255, 255, 255, 0.98); 
            backdrop-filter: blur(12px); 
            position: fixed; 
            top: 0; 
            width: 100%; 
            box-sizing: border-box;
            justify-content: center; 
            align-items: center;
            z-index: 1000; 
            border-bottom: 2px solid var(--stanford-red);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        #top-utilities {
            position: absolute;
            right: 40px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .lang-group { display: flex; gap: 12px; align-items: center; }

        .util-btn { cursor: pointer; color: #888; transition: 0.2s; border-bottom: 1px solid transparent; }
        .util-btn:hover { color: var(--stanford-red); }
        .util-btn.active { color: var(--stanford-red); border-bottom: 1px solid var(--stanford-red); }

        .reset-trigger { 
            color: var(--stanford-red); 
            border: 1px solid var(--stanford-red); 
            padding: 2px 10px; 
            background: transparent; 
            font-size: 10px; 
            transition: 0.2s;
        }
        .reset-trigger:hover { background: var(--stanford-red); color: #fff; }

        .node { 
            width: 320px; padding: 12px 20px; 
            border: 1px solid var(--border-light); 
            text-align: left; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            background: #FFFFFF; 
        }
        .node:hover { border-color: var(--stanford-red); background: #FFF9F9; }
        .node.active { 
            border: 2px solid var(--stanford-red); 
            box-shadow: 0 4px 12px rgba(140, 21, 21, 0.1);
        }

        .label { 
            font-size: 9px; font-weight: 700; color: var(--stanford-red); 
            margin-bottom: 4px; letter-spacing: 1.2px; text-transform: uppercase;
        }

        .val { font-size: 14px; font-weight: 600; color: #444; min-height: 1.2em; line-height: 1.3; }

        /* --- 4. Êä•ÂëäÂÜÖÂÆπÂ±ïÁ§∫Âå∫ --- */
        #analysis-stage { width: 850px; margin-bottom: 80px; }

        .history-entry { 
            margin-bottom: 50px; 
            border-top: 1px solid var(--border-light); 
            padding-top: 30px; 
            scroll-margin-top: 220px; 
        }
        
        .basic-card { 
            padding: 30px; background: #FFFFFF; border: 1px solid var(--border-light); 
            margin-bottom: 25px; color: #444; line-height: 1.8; font-size: 16px;
        }

        .content-card { 
            background: #FFFFFF; border: 1px solid var(--border-light); 
            padding: 40px; margin-bottom: 25px; line-height: 1.8; 
            border-left: 8px solid var(--stanford-red);
            box-shadow: 4px 4px 0px rgba(0,0,0,0.02);
        }

        .section-header { 
            color: var(--stanford-red); font-family: "Georgia", serif; 
            font-size: 24px; font-weight: 800; margin-bottom: 20px; 
            display: block; border-bottom: 1px solid var(--stanford-red); padding-bottom: 10px; 
        }

        .sub-title { color: var(--text-dark); font-weight: 700; display: block; margin-top: 25px; font-size: 18px; }
        .list-item { margin: 14px 0; display: flex; align-items: flex-start; color: #555; font-size: 16px; }
        .list-item::before { content: "‚Ä¢"; color: var(--stanford-red); margin-right: 15px; font-size: 20px; line-height: 1; }
        .highlight { color: var(--stanford-red); font-weight: 700; }

        /* --- 5. ËæìÂÖ•Âå∫Âüü --- */
        .input-box { 
            margin-top: 40px; display: flex; width: 850px; 
            margin-bottom: 100px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
        }
        
        input { 
            flex: 1; background: #FFFFFF; border: 1px solid var(--border-light); 
            color: var(--text-dark); padding: 20px; outline: none; font-size: 16px; 
        }

        button { 
            background: var(--stanford-red); border: none; color: #FFFFFF; 
            padding: 0 45px; cursor: pointer; font-weight: 700; 
            text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; 
        }
        button:hover { background: #6b0f0f; }

        @media (max-width: 1100px) {
            #top-utilities { position: relative; right: auto; flex-direction: row; margin-left: 20px; }
            #top-monitor { padding: 15px 10px; }
            #side-persona-monitor { display: none; } 
        }
    </style>
</head>
<body>

    <div id="side-persona-monitor">
        <div class="scanner-title">PERSONA SCAN</div>
        <div class="weight-box">
            <div class="weight-info"><span>Will / ÊùÉÂäõÊÑèÂøó</span><span id="v-will">0%</span></div>
            <div class="progress-bg"><div id="b-will" class="progress-fill"></div></div>
        </div>
        <div class="weight-box">
            <div class="weight-info"><span>Moral / ÈÅìÂæ∑ÊàêÊú¨</span><span id="v-moral">0%</span></div>
            <div class="progress-bg"><div id="b-moral" class="progress-fill"></div></div>
        </div>
        <div class="weight-box">
            <div class="weight-info"><span>Cognitive / ËÆ§Áü•Ê†ºÂ±Ä</span><span id="v-cog">0%</span></div>
            <div class="progress-bg"><div id="b-cog" class="progress-fill"></div></div>
        </div>
        <div class="weight-box">
            <div class="weight-info"><span>Base / ÊÉÖÊÑüÂ∫ïËâ≤</span><span id="v-base">0%</span></div>
            <div class="progress-bg"><div id="b-base" class="progress-fill"></div></div>
        </div>
    </div>

    <div id="top-monitor">
        <div class="node" id="main-node" onclick="confirmIntent('main')">
            <div class="label" id="lbl-main">Êé¢Êµã‰∏ªË¶ÅÁüõÁõæ</div>
            <div id="main-val" class="val"></div>
        </div>
        <div class="node" id="hidden-node" onclick="confirmIntent('hidden')">
            <div class="label" id="lbl-hidden">Êé¢ÊµãÊΩúÂú®ÊÑèÂõæ</div>
            <div id="hidden-val" class="val"></div>
        </div>

        <div id="top-utilities">
            <div class="lang-group">
                <span class="util-btn active" id="btn-zh" onclick="switchLang('zh')">ZH</span>
                <span style="color:#D5D5D5">|</span>
                <span class="util-btn" id="btn-en" onclick="switchLang('en')">EN</span>
            </div>
            <div class="util-btn reset-trigger" onclick="resetSystem()">RESET</div>
        </div>
    </div>

    <div id="analysis-stage"></div>

    <div class="input-box">
        <input type="text" id="userInput" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÁ†îÁ©∂ËØæÈ¢òÊàñÊàòÁï•ÂÜ≥Á≠ñËÆÆÈ¢ò...">
        <button id="btn-submit" onclick="detect()">ÂêØÂä®ÂàÜÊûê</button>
    </div>

    <script>
        /* --- JS ÂèòÈáè‰∏éÂ≠òÂÇ® --- */
        let store = { 
            main: "", 
            hidden: "", 
            raw: "",      
            persona: "",  
            weights: {}   
        };
        let currentLang = 'zh';

        const i18n = {
            zh: {
                mainLbl: "Êé¢Êµã‰∏ªË¶ÅÁüõÁõæ",
                hiddenLbl: "Êé¢ÊµãÊΩúÂú®ÊÑèÂõæ",
                placeholder: "ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÁ†îÁ©∂ËØæÈ¢òÊàñÊàòÁï•ÂÜ≥Á≠ñËÆÆÈ¢ò...",
                btnSubmit: "ÂêØÂä®ÂàÜÊûê",
                analyzing: "Ê≠£Âú®ÂàÜÊûê...",
                probing: "Ê≠£Âú®Êé¢Êµã...",
                subject: "Á†îÁ©∂ËÆÆÈ¢ò",
                executing: "Ê≠£Âú®ÊâßË°åÊ∑±Â∫¶ÊàòÁï•ÂàÜÊûê...",
                pivot: "Á°ÆËÆ§ÊàòÁï•ÈáçÂøÉ",
                terminated: "ÂàÜÊûêÁªàÊ≠¢„ÄÇ",
                resetMsg: "Á≥ªÁªüÂ∑≤ÈáçÁΩÆ„ÄÇÊÇ®ÂèØ‰ª•ÂºÄÂêØÊñ∞ÁöÑËÆÆÈ¢òÊàñËøõË°åÊôÆÈÄöÊü•ËØ¢„ÄÇ"
            },
            en: {
                mainLbl: "Primary Strategic Conflict",
                hiddenLbl: "Underlying Strategic Intent",
                placeholder: "Enter your research subject or strategic issue...",
                btnSubmit: "Execute Analysis",
                analyzing: "Analyzing...",
                probing: "Probing...",
                subject: "Research Subject",
                executing: "Executing In-depth Strategic Analysis...",
                pivot: "Confirmed Strategic Pivot",
                terminated: "Analysis Terminated.",
                resetMsg: "System reset. You can start a new topic or general inquiry."
            }
        };

        /* --- Ê†∏ÂøÉ‰∫§‰∫íÈÄªËæë --- */
        function switchLang(lang) {
            currentLang = lang;
            document.querySelectorAll('.util-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + lang).classList.add('active');
            document.getElementById('lbl-main').innerText = i18n[lang].mainLbl;
            document.getElementById('lbl-hidden').innerText = i18n[lang].hiddenLbl;
            document.getElementById('userInput').placeholder = i18n[lang].placeholder;
            document.getElementById('btn-submit').innerText = i18n[lang].btnSubmit;
        }

        function resetSystem() {
            store = { main: "", hidden: "", raw: "", persona: "", weights: {} };
            document.getElementById('main-val').innerText = "";
            document.getElementById('hidden-val').innerText = "";
            
            ['will', 'moral', 'cog', 'base'].forEach(id => {
                document.getElementById(`b-${id}`).style.width = '0%';
                document.getElementById(`v-${id}`).innerText = '0%';
            });

            document.querySelectorAll('.node').forEach(n => n.classList.remove('active'));
            const stage = document.getElementById('analysis-stage');
            stage.innerHTML += `<div style="text-align:center; color:#8C1515; font-size:11px; margin: 30px 0; border-top:1px solid #D5D5D5; padding-top:10px; letter-spacing:1px; text-transform:uppercase;">${i18n[currentLang].resetMsg}</div>`;
            document.getElementById('userInput').value = '';
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function robustParse(raw) {
            let clean = raw.replace(/\\n/g, '\n').replace(/\\"/g, '"');
            const sections = clean.split(/(?=\d\.\s*„Äê|###\s*)/g);
            let htmlOutput = "";
            sections.forEach(sec => {
                if (sec.trim().length < 5) return;
                let formatted = sec.replace(/(\d\.\s*„Äê|###\s*)(.*?)(„Äë|\n|$)/, '<span class="section-header">$2</span>');
                formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<span class="highlight">$1</span>');
                formatted = formatted.replace(/^- (.*?):/gm, '<span class="sub-title">$1</span>');
                formatted = formatted.replace(/^- (.*)/gm, '<div class="list-item">$1</div>');
                htmlOutput += `<div class="content-card">${formatted}</div>`;
            });
            return htmlOutput || `<div class="content-card">${raw}</div>`;
        }

        async function detect() {
            const inputField = document.getElementById('userInput');
            const q = inputField.value;
            if(!q) return;
            const t = i18n[currentLang];
            
            store.raw = q;
            document.getElementById('main-val').innerText = t.analyzing;
            document.getElementById('hidden-val').innerText = t.probing;
            
            try {
                const res = await fetch(`/infer?q=${encodeURIComponent(q)}`);
                const data = await res.json();
                
                store.main = data.main;
                store.hidden = data.hidden;
                store.persona = data.persona_brief;
                store.weights = data.weights;

                updateScanner(data.weights);

                document.getElementById('main-val').innerHTML = `${data.main} <small style="color:#999; font-size:10px;">[${data.persona_tags.join('¬∑')}]</small>`;
                document.getElementById('hidden-val').innerText = data.hidden || "";
                
                const stage = document.getElementById('analysis-stage');
                const newEntryId = 'chat-' + Date.now();
                stage.innerHTML += `
                    <div class="history-entry" id="${newEntryId}">
                        <div style="color: var(--stanford-red); font-weight:800; font-size:12px; margin-bottom:15px; text-transform:uppercase;">${t.subject}: ${q}</div>
                        <div class="basic-card">
                            <div style="font-size:12px; color:var(--stanford-red); font-weight:700; margin-bottom:10px;">üë§ Â∫ïÂ±Ç‰∫∫Ê†ºÁîªÂÉè: ${data.persona_brief}</div>
                            ${data.chat_reply.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
                inputField.value = '';
                document.getElementById(newEntryId).scrollIntoView({ behavior: 'smooth' });
            } catch(e) {
                document.getElementById('main-val').innerText = "Connection Failed";
            }
        }

        function updateScanner(w) {
            const map = { will: 'will', moral: 'moral', cognitive: 'cog', base: 'base' };
            for(let key in map) {
                const val = w[key] || 0;
                const id = map[key];
                document.getElementById(`b-${id}`).style.width = val + '%';
                document.getElementById(`v-${id}`).innerText = val + '%';
            }
        }

        async function confirmIntent(type) {
            const target = store[type];
            if(!target || target.includes("...")) return;
            const t = i18n[currentLang];
            
            document.querySelectorAll('.node').forEach(n => n.classList.remove('active'));
            document.getElementById(type + '-node').classList.add('active');
            
            const stage = document.getElementById('analysis-stage');
            const entryId = 'entry-' + Date.now();
            stage.innerHTML += `<div class="history-entry" id="${entryId}"><div style="text-align:center; color:var(--stanford-red); font-weight:bold; padding:40px;">${t.executing}</div></div>`;
            document.getElementById(entryId).scrollIntoView({ behavior: 'smooth' });
            
            try {
                const params = new URLSearchParams({
                    target: target,
                    raw: store.raw,
                    persona: store.persona,
                    weights: JSON.stringify(store.weights)
                });
                
                const res = await fetch(`/analyze?${params.toString()}`);
                const content = await res.text();
                const container = document.getElementById(entryId);
                container.innerHTML = `
                    <div style="color: var(--stanford-red); margin-bottom: 25px; font-weight: bold; font-size: 14px; text-transform: uppercase;">${t.pivot}: ${target}</div>
                    ${robustParse(content)}
                `;
                container.scrollIntoView({ behavior: 'smooth' });
            } catch(e) {
                document.getElementById(entryId).innerHTML = t.terminated;
            }
        }
        
        switchLang('zh');
    </script>
</body>
</html>